/* Last modified: 27-Feb-2026 14:43 */
const e=[{value:0,color:"#1a237e"},{value:32,color:"#42a5f5"},{value:40,color:"#80deea"},{value:50,color:"#66bb6a"},{value:60,color:"#4caf50"},{value:70,color:"#81c784"},{value:75,color:"#ffeb3b"},{value:80,color:"#ff9800"},{value:85,color:"#f44336"}],t=[{value:-18,color:"#1a237e"},{value:0,color:"#42a5f5"},{value:4,color:"#80deea"},{value:10,color:"#66bb6a"},{value:16,color:"#4caf50"},{value:21,color:"#81c784"},{value:24,color:"#ffeb3b"},{value:27,color:"#ff9800"},{value:29,color:"#f44336"}];function n(e){if(e.startsWith("#")){const t=e.replace("#","");if(6===t.length)return{r:parseInt(t.substr(0,2),16),g:parseInt(t.substr(2,2),16),b:parseInt(t.substr(4,2),16)}}if(e.startsWith("rgba(")){const t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);if(t)return{r:parseInt(t[1],10),g:parseInt(t[2],10),b:parseInt(t[3],10)}}if(e.startsWith("rgb(")){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t)return{r:parseInt(t[1],10),g:parseInt(t[2],10),b:parseInt(t[3],10)}}return null}function i(e){const t=e=>Math.max(0,Math.min(255,Math.round(e))).toString(16).padStart(2,"0");return`#${t(e.r)}${t(e.g)}${t(e.b)}`}function r(e){const t=e.r/255,n=e.g/255,i=e.b/255,r=Math.max(t,n,i),o=Math.min(t,n,i);let a=0,s=0;const l=(r+o)/2;if(r!==o){const e=r-o;switch(s=l>.5?e/(2-r-o):e/(r+o),r){case t:a=(n-i)/e+(n<i?6:0);break;case n:a=(i-t)/e+2;break;case i:a=(t-n)/e+4}a*=60}return{h:a,s:s,l:l}}function o(e,t,n){const o=r(e),a=r(t);let s=a.h-o.h;Math.abs(s)>180&&(s-=360*Math.sign(s));return i(function(e){const{h:t,s:n,l:i}=e,r=(1-Math.abs(2*i-1))*n,o=r*(1-Math.abs(t/60%2-1)),a=i-r/2;let s=0,l=0,c=0;return[s,l,c]=t<60?[r,o,0]:t<120?[o,r,0]:t<180?[0,r,o]:t<240?[0,o,r]:t<300?[o,0,r]:[r,0,o],{r:255*(s+a),g:255*(l+a),b:255*(c+a)}}({h:(o.h+s*n+360)%360,s:o.s+(a.s-o.s)*n,l:o.l+(a.l-o.l)*n}))}function a(e){const t=(n=e.r,i=e.g,r=e.b,[n,i,r]=[n,i,r].map(e=>(e/=255)>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92),{x:100*(.4124*n+.3576*i+.1805*r),y:100*(.2126*n+.7152*i+.0722*r),z:100*(.0193*n+.1192*i+.9505*r)});var n,i,r;const o=[95.047,100,108.883];let a=t.x/o[0],s=t.y/o[1],l=t.z/o[2];return[a,s,l]=[a,s,l].map(e=>e>.008856?Math.cbrt(e):7.787*e+16/116),{l:116*s-16,a:500*(a-s),b:200*(s-l)}}function s(e){let t=(e.l+16)/116,n=e.a/500+t,i=t-e.b/200;return[n,t,i]=[n,t,i].map(e=>{const t=e**3;return t>.008856?t:(e-16/116)/7.787}),n*=95.047,t*=100,i*=108.883,function(e,t,n){let i=-.9689*(e/=100)+1.8758*(t/=100)+.0415*(n/=100),r=.0557*e+-.204*t+1.057*n;const o=e=>e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e;return{r:255*o(3.2406*e+-1.5372*t+-.4986*n),g:255*o(i),b:255*o(r)}}(n,t,i)}function l(e,t,r,l="hsl"){const c=n(e),d=n(t);if(!c||!d)return e;switch(l){case"rgb":return function(e,t,n){return i({r:Math.round(e.r+(t.r-e.r)*n),g:Math.round(e.g+(t.g-e.g)*n),b:Math.round(e.b+(t.b-e.b)*n)})}(c,d,r);case"gamma":return function(e,t,n,r=2.2){const o=(e,t)=>255*Math.pow(Math.pow(e/255,r)+(Math.pow(t/255,r)-Math.pow(e/255,r))*n,1/r);return i({r:o(e.r,t.r),g:o(e.g,t.g),b:o(e.b,t.b)})}(c,d,r);case"hsl":default:return o(c,d,r);case"lab":return function(e,t,n){const r=a(e),o=a(t);return i(s({l:r.l+(o.l-r.l)*n,a:r.a+(o.a-r.a)*n,b:r.b+(o.b-r.b)*n}))}(c,d,r)}}function c(e,t,n=!1,i="hsl"){if(null==e)return"var(--disabled-color, #f0f0f0)";if(!n){let n=t[0].color;for(let i=0;i<t.length&&e>=t[i].value;i++)n=t[i].color;return n}if(e<=t[0].value)return t[0].color;if(e>=t[t.length-1].value)return t[t.length-1].color;for(let n=0;n<t.length-1;n++)if(e>=t[n].value&&e<t[n+1].value){const r=(e-t[n].value)/(t[n+1].value-t[n].value);return l(t[n].color,t[n+1].color,r,i)}return t[t.length-1].color}function d(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function h(e,t="24"){if("24"===t)return String(e).padStart(2,"0");return`${0===e?12:e>12?e-12:e}${e<12?"a":"p"}`}function p(e,t){return null==e||""===e?t:"number"==typeof e?`${e}px`:String(e)}function u(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function g(e,t){return Math.floor(e/t)*t}class _ extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._config={},this._hass=null,this._historyData=null,this._processedData=null,this._lastFetch=0,this._viewOffset=0,this._isLoading=!1,this._error=null,this._interval=null,this.shadowRoot.appendChild(function(){const e=document.createElement("style");return e.textContent="\n    /* Main container */\n    ha-card {\n      display: block;\n      padding: 0;\n      overflow: hidden;\n    }\n\n    /* Card header with title and navigation */\n    .card-header {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 16px;\n      border-bottom: 1px solid var(--divider-color);\n      flex-wrap: wrap;\n      gap: 8px;\n    }\n\n    .title {\n      font-size: 20px;\n      font-weight: 500;\n      color: var(--primary-text-color);\n    }\n\n    /* Navigation controls */\n    .nav-controls {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n    }\n\n    .nav-btn {\n      background: var(--primary-color);\n      color: var(--text-primary-color, white);\n      border: none;\n      border-radius: 4px;\n      width: 32px;\n      height: 32px;\n      font-size: 18px;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: opacity 0.2s ease;\n    }\n\n    .nav-btn:hover:not(:disabled) {\n      opacity: 0.8;\n    }\n\n    .nav-btn:disabled {\n      opacity: 0.3;\n      cursor: not-allowed;\n    }\n\n    .nav-btn:focus {\n      outline: 2px solid var(--primary-color);\n      outline-offset: 2px;\n    }\n\n    .nav-btn-current {\n      background: var(--primary-color);\n      color: var(--text-primary-color, white);\n      border: none;\n      border-radius: 4px;\n      padding: 6px 12px;\n      font-size: 13px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: opacity 0.2s ease;\n    }\n\n    .nav-btn-current:hover {\n      opacity: 0.8;\n    }\n\n    .nav-btn-current:focus {\n      outline: 2px solid var(--primary-color);\n      outline-offset: 2px;\n    }\n\n    .nav-btn-current.hidden {\n      visibility: hidden;\n      pointer-events: none;\n    }\n\n    .date-range {\n      font-size: 14px;\n      color: var(--secondary-text-color);\n      min-width: 120px;\n      text-align: center;\n    }\n\n    /* Heatmap grid container */\n    .heatmap-grid {\n      padding: 16px;\n    }\n\n    .month-header {\n      text-align: center;\n      font-size: 16px;\n      font-weight: 500;\n      color: var(--primary-text-color);\n      margin-bottom: 12px;\n    }\n\n    /* Grid wrapper with time labels and data grid */\n    .grid-wrapper {\n      display: grid;\n      grid-template-columns: auto 1fr;\n      gap: 8px;\n      align-items: start;\n    }\n\n    /* Time labels column */\n    .time-labels {\n      display: flex;\n      flex-direction: column;\n      gap: var(--cell-gap, 2px);\n      padding-top: 28px;  /* Align with data grid (after date headers) */\n    }\n\n    .time-label {\n      height: var(--cell-height, 36px);\n      display: flex;\n      align-items: center;\n      justify-content: flex-end;\n      padding-right: 8px;\n      font-size: var(--cell-font-size, 11px);\n      color: var(--secondary-text-color);\n      font-weight: 500;\n    }\n\n    /* Data grid container */\n    .data-grid-container {\n      display: flex;\n      flex-direction: column;\n      gap: 4px;\n    }\n\n    /* Date headers row */\n    .date-headers {\n      display: grid;\n      grid-template-columns: repeat(var(--days-count, 7), 1fr);\n      gap: 2px;\n      margin-bottom: 4px;\n    }\n\n    .date-header {\n      text-align: center;\n      font-weight: bold;\n      font-size: 12px;\n      color: var(--primary-text-color);\n      padding: 4px;\n    }\n\n    /* Data cells grid */\n    .data-grid {\n      display: grid;\n      grid-template-columns: repeat(var(--days-count, 7), var(--cell-width, 1fr));\n      grid-auto-rows: var(--cell-height, 36px);\n      gap: var(--cell-gap, 2px);\n    }\n\n    /* Individual cells */\n    .cell {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      border-radius: var(--cell-border-radius, 4px);\n      cursor: pointer;\n      transition: transform 0.1s ease, box-shadow 0.1s ease;\n      position: relative;\n      font-size: var(--cell-font-size, 11px);\n      padding: var(--cell-padding, 2px);\n      box-sizing: border-box;\n    }\n\n    /* Only apply hover effects on devices with a true hover-capable pointer.\n       On touch devices, :hover is sticky after tap and can cause the cell to\n       render on top of the more-info popup due to the transform stacking context. */\n    @media (hover: hover) {\n      .cell:hover:not(.no-data) {\n        transform: scale(1.08);\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n        z-index: 10;\n      }\n\n      .cell.no-data:hover {\n        transform: none;\n        box-shadow: none;\n      }\n    }\n\n    .cell:focus {\n      outline: 2px solid var(--primary-color);\n      outline-offset: 2px;\n    }\n\n    .cell.no-data {\n      background-color: var(--disabled-color, #f0f0f0);\n      cursor: default;\n      opacity: 0.4;\n    }\n\n    .cell.partial {\n      border: 2px dashed currentColor;\n      opacity: 0.9;\n    }\n\n    /* Gap-filled cell: estimated value from last known reading */\n    .cell.filled {\n      opacity: 0.6;\n      border: 1px dashed currentColor;\n    }\n\n    .temperature {\n      font-weight: bold;\n      line-height: 1.1;\n    }\n\n    /* Footer with statistics */\n    .footer {\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n      padding: 12px 16px;\n      border-top: 1px solid var(--divider-color);\n      background: var(--card-background-color);\n      font-size: 13px;\n      color: var(--secondary-text-color);\n    }\n\n    .footer-stats {\n      display: flex;\n      justify-content: space-around;\n      align-items: center;\n    }\n\n    .footer-stats span {\n      font-weight: 500;\n    }\n\n    .entity-name {\n      text-align: center;\n      font-size: 11px;\n      color: var(--secondary-text-color);\n      opacity: 0.8;\n    }\n\n    /* Loading state */\n    .loading {\n      text-align: center;\n      padding: 32px;\n      color: var(--secondary-text-color);\n    }\n\n    .loading-spinner {\n      display: inline-block;\n      width: 24px;\n      height: 24px;\n      border: 3px solid var(--divider-color);\n      border-top-color: var(--primary-color);\n      border-radius: 50%;\n      animation: spin 1s linear infinite;\n    }\n\n    @keyframes spin {\n      to { transform: rotate(360deg); }\n    }\n\n    /* Error message */\n    .error-message {\n      display: flex;\n      align-items: flex-start;\n      gap: 12px;\n      padding: 16px;\n      margin: 16px;\n      background: rgba(244, 67, 54, 0.1);\n      color: var(--error-color, #f44336);\n      border-radius: 4px;\n      border-left: 4px solid var(--error-color, #f44336);\n    }\n\n    .error-icon {\n      font-size: 20px;\n      flex-shrink: 0;\n    }\n\n    .error-text {\n      flex: 1;\n    }\n\n    .error-details {\n      font-size: 11px;\n      margin-top: 4px;\n      opacity: 0.8;\n    }\n\n    /* Tooltip */\n    .tooltip {\n      position: absolute;\n      z-index: 1000;\n      background: var(--card-background-color, white);\n      border: 1px solid var(--divider-color);\n      border-radius: 4px;\n      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);\n      padding: 8px 12px;\n      font-size: 12px;\n      pointer-events: none;\n      max-width: 250px;\n      line-height: 1.4;\n    }\n\n    .tooltip div {\n      margin: 2px 0;\n    }\n\n    .tooltip strong {\n      color: var(--primary-text-color);\n    }\n\n    /* Legend bar */\n    .legend {\n      padding: 8px 16px 12px;\n      border-top: 1px solid var(--divider-color);\n    }\n\n    .legend-bar {\n      height: 12px;\n      border-radius: 3px;\n      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);\n    }\n\n    .legend-labels {\n      position: relative;\n      height: 14px;\n      margin-top: 4px;\n      font-size: 9px;\n      color: var(--secondary-text-color);\n    }\n\n    .legend-labels span {\n      white-space: nowrap;\n    }\n\n    /* Responsive adjustments */\n    @media (max-width: 600px) {\n      .data-grid {\n        grid-auto-rows: calc(var(--cell-height, 36px) * 0.83);\n      }\n\n      .time-label {\n        height: calc(var(--cell-height, 36px) * 0.83);\n        font-size: calc(var(--cell-font-size, 11px) * 0.91);\n      }\n\n      .cell {\n        font-size: calc(var(--cell-font-size, 11px) * 0.91);\n      }\n\n      .date-header {\n        font-size: 11px;\n      }\n    }\n\n    @media (max-width: 400px) {\n      .card-header {\n        flex-direction: column;\n        align-items: stretch;\n      }\n\n      .nav-controls {\n        justify-content: center;\n      }\n    }\n\n    /* Accessibility: High contrast mode support */\n    @media (prefers-contrast: high) {\n      .cell:not(.no-data) {\n        border: 1px solid currentColor;\n      }\n    }\n\n    /* Accessibility: Reduced motion support */\n    @media (prefers-reduced-motion: reduce) {\n      .cell,\n      .nav-btn,\n      .loading-spinner {\n        transition: none;\n        animation: none;\n      }\n    }\n  ",e}()),this._content=document.createElement("ha-card"),this.shadowRoot.appendChild(this._content),this._content.addEventListener("click",this._handleClick.bind(this)),this._responseCache=new Map}setConfig(e){if(!e.entity)throw new Error("'entity' is required (temperature sensor)");const t=[1,2,3,4,6,8,12,24];if(e.time_interval&&!t.includes(e.time_interval))throw new Error(`time_interval must be one of: ${t.join(", ")}`);if(e.days&&(e.days<1||e.days>30))throw new Error("days must be between 1 and 30");const n=["average","min","max"];if(e.aggregation_mode&&!n.includes(e.aggregation_mode))throw new Error(`aggregation_mode must be one of: ${n.join(", ")}`);const i=["rgb","gamma","hsl","lab"];if(e.color_interpolation&&!i.includes(e.color_interpolation))throw new Error(`color_interpolation must be one of: ${i.join(", ")}`);const r=["auto","history","statistics"];if(e.data_source&&!r.includes(e.data_source))throw new Error(`data_source must be one of: ${r.join(", ")}`);const o=["mean","min","max"];if(e.statistic_type&&!o.includes(e.statistic_type))throw new Error(`statistic_type must be one of: ${o.join(", ")}`);if(void 0!==e.decimals&&(e.decimals<0||e.decimals>2))throw new Error("decimals must be between 0 and 2");if(void 0!==e.start_hour&&(!Number.isInteger(e.start_hour)||e.start_hour<0||e.start_hour>23))throw new Error("start_hour must be an integer between 0 and 23");if(void 0!==e.end_hour&&(!Number.isInteger(e.end_hour)||e.end_hour<0||e.end_hour>23))throw new Error("end_hour must be an integer between 0 and 23");if(void 0!==e.cell_height){const t="number"==typeof e.cell_height?e.cell_height:parseFloat(e.cell_height);if(isNaN(t)||t<10||t>200)throw new Error("cell_height must be between 10 and 200 pixels")}if(void 0!==e.cell_padding){const t="number"==typeof e.cell_padding?e.cell_padding:parseFloat(e.cell_padding);if(isNaN(t)||t<0||t>20)throw new Error("cell_padding must be between 0 and 20 pixels")}if(void 0!==e.cell_gap){const t="number"==typeof e.cell_gap?e.cell_gap:parseFloat(e.cell_gap);if(isNaN(t)||t<0||t>20)throw new Error("cell_gap must be between 0 and 20 pixels")}if(void 0!==e.cell_font_size){const t="number"==typeof e.cell_font_size?e.cell_font_size:parseFloat(e.cell_font_size);if(isNaN(t)||t<6||t>24)throw new Error("cell_font_size must be between 6 and 24 pixels")}if(void 0!==e.cell_width&&"string"!=typeof e.cell_width){const t=parseFloat(e.cell_width);if(isNaN(t)||t<10||t>500)throw new Error("cell_width as number must be between 10 and 500 pixels")}this._config={entity:e.entity,title:e.title||"Temperature History",days:e.days||7,time_interval:e.time_interval||2,time_format:e.time_format||"24",start_hour:void 0!==e.start_hour?e.start_hour:0,end_hour:void 0!==e.end_hour?e.end_hour:23,aggregation_mode:e.aggregation_mode||"average",decimals:void 0!==e.decimals?e.decimals:1,unit:e.unit||null,color_thresholds:e.color_thresholds&&e.color_thresholds.length>0?e.color_thresholds:this._getDefaultThresholds(),refresh_interval:e.refresh_interval||300,click_action:e.click_action||"more-info",show_entity_name:e.show_entity_name||!1,show_legend:e.show_legend||!1,show_degree_symbol:!1!==e.show_degree_symbol,cell_height:void 0!==e.cell_height?e.cell_height:36,cell_width:void 0!==e.cell_width?e.cell_width:"1fr",cell_padding:void 0!==e.cell_padding?e.cell_padding:2,cell_gap:void 0!==e.cell_gap?e.cell_gap:2,cell_font_size:void 0!==e.cell_font_size?e.cell_font_size:11,compact:e.compact||!1,rounded_corners:!1!==e.rounded_corners,interpolate_colors:e.interpolate_colors||!1,color_interpolation:e.color_interpolation||"hsl",data_source:e.data_source||"auto",statistic_type:e.statistic_type||"mean",fill_gaps:e.fill_gaps||!1},this._config.color_thresholds=[...this._config.color_thresholds].sort((e,t)=>e.value-t.value),this._hass&&this._clearAndSetInterval()}static getConfigElement(){return document.createElement("ha-temperature-heatmap-card-editor")}static getStubConfig(n){const i=Object.keys(n.states).filter(e=>{if(!e.startsWith("sensor."))return!1;const t=n.states[e];return"temperature"===t?.attributes?.device_class});let r=e.slice();if(i.length>0){const e=n.states[i[0]]?.attributes?.unit_of_measurement||"";(e.toLowerCase().includes("c")||"°C"===e)&&(r=t.slice())}return{entity:i.length>0?i[0]:"",title:"Temperature History",days:7,time_interval:2,aggregation_mode:"average",color_thresholds:r}}_getDefaultThresholds(){return function(n){if(!n)return e;const i=n.toLowerCase().trim();return i.includes("c")||"°c"===i||"celsius"===i?t:e}(this._getUnit().toLowerCase())}set hass(e){this._hass=e,this._config&&this.isConnected&&0===this._viewOffset&&this._isDataStale()&&this._fetchHistoryData()}getCardSize(){const e=this._processedData?this._processedData.rows.length:12,t=this._getEffectiveSizing(),n=parseFloat(t.cellHeight)||36;return Math.ceil((e*n+100)/50)}connectedCallback(){this._config&&this._hass&&this._clearAndSetInterval()}disconnectedCallback(){this._interval&&(clearInterval(this._interval),this._interval=null)}_clearAndSetInterval(){this._interval&&(clearInterval(this._interval),this._interval=null),this._fetchHistoryData();const e=1e3*this._config.refresh_interval;this._interval=setInterval(()=>{0===this._viewOffset&&this._fetchHistoryData()},e)}_isDataStale(){if(!this._historyData||!this._lastFetch)return!0;return Date.now()-this._lastFetch>1e3*this._config.refresh_interval}async fetchWithCache(e,t=3e4,n=3e5){const i=Date.now(),r=`${e}_offset${this._viewOffset}`,o=this._responseCache.get(r);if(o&&o.expiry>i)return console.log("Using cached data for:",r),o.data;const a=this._hass.callApi("GET",e),s=await Promise.race([a,new Promise((e,n)=>setTimeout(()=>n(new Error(`Request timeout after ${t}ms`)),t))]);return this._responseCache.set(r,{data:s,expiry:i+n}),s}_getDataSource(){const e=this._config.data_source;return"history"===e?"history":"statistics"===e||this._viewOffset<0?"statistics":"history"}async _fetchHistoryData(){if(this._isLoading)return void console.log("Temperature Heatmap: Already loading, skipping duplicate fetch");this._isLoading=!0,this._error=null,this._render();const e=this._getDataSource();console.log(`Temperature Heatmap: Starting data fetch using ${e}...`);try{const t=new Date;let n,i=null;if(0===this._viewOffset){n=new Date(t);const e=this._config.time_interval,r=u(t);i=`${r}_${g(t.getHours(),e)}`}else n=new Date(t),n.setDate(n.getDate()+this._viewOffset),n.setHours(23,59,59,999);const r=new Date(n);r.setDate(r.getDate()-this._config.days+1),r.setHours(0,0,0,0),console.log(`Temperature Heatmap: Fetching from ${r.toLocaleString()} to ${n.toLocaleString()}`),i&&console.log(`Temperature Heatmap: Current partial bucket: ${i}`),"statistics"===e?await this._fetchStatisticsData(r,n,i):await this._fetchHistoryApiData(r,n,i),this._lastFetch=Date.now();const o=Date.now();this._processData();const a=((Date.now()-o)/1e3).toFixed(2);console.log(`Temperature Heatmap: Processed data in ${a}s`),this._isLoading=!1,console.log("Temperature Heatmap: Starting render..."),this._render(),console.log("Temperature Heatmap: Render complete")}catch(e){console.error("Temperature Heatmap: Fetch error:",e),this._isLoading=!1,this._error={message:"Failed to fetch temperature history",details:e.message},this._render()}}async _fetchHistoryApiData(e,t,n=null){const i=e.toISOString(),r=t.toISOString();console.log(`Temperature Heatmap: Using history API - Start: ${i}, End: ${r}`);const o=`history/period/${i}?filter_entity_id=${this._config.entity}&end_time=${r}&minimal_response&no_attributes`,a=Date.now(),s=await this.fetchWithCache(o),l=((Date.now()-a)/1e3).toFixed(1);console.log(`Temperature Heatmap: Received ${s?.[0]?.length||0} temperature points in ${l}s`),this._historyData={temperature:s?.[0]||[],startTime:e,endTime:t,partialBucketKey:n,dataSource:"history"}}async _fetchStatisticsData(e,t,n=null){const i=e.toISOString(),r=t.toISOString();console.log(`Temperature Heatmap: Using statistics API - Start: ${i}, End: ${r}`);const o=Date.now(),a=await((e,t=3e4)=>Promise.race([e,new Promise((e,n)=>setTimeout(()=>n(new Error("Request timeout after 30 seconds")),t))]))(this._hass.callWS({type:"recorder/statistics_during_period",start_time:i,end_time:r,statistic_ids:[this._config.entity],period:"hour"})),s=((Date.now()-o)/1e3).toFixed(1),l=a[this._config.entity]||[];console.log(`Temperature Heatmap: Received ${l.length} temperature stats in ${s}s`);const c=this._config.statistic_type,d=l.map(e=>({last_changed:e.start,state:String(e[c]??e.mean??"")})).filter(e=>""!==e.state&&"null"!==e.state);this._historyData={temperature:d,startTime:e,endTime:t,partialBucketKey:n,dataSource:"statistics"}}_processData(){if(!this._historyData)return void(this._processedData=null);const{temperature:e,startTime:t,partialBucketKey:n}=this._historyData,i=this._config.time_interval,r=24/i,o={};e.forEach(e=>{const t=new Date(e.last_changed||e.last_updated),n=`${u(t)}_${g(t.getHours(),i)}`;o[n]||(o[n]={sum:0,count:0,min:null,max:null});const r=parseFloat(e.state);isNaN(r)||(o[n].sum+=r,o[n].count+=1,o[n].min=null===o[n].min?r:Math.min(o[n].min,r),o[n].max=null===o[n].max?r:Math.max(o[n].max,r))}),Object.keys(o).forEach(e=>{const t=o[e];if(t.count>0)switch(this._config.aggregation_mode){case"min":t.temperature=t.min;break;case"max":t.temperature=t.max;break;default:t.temperature=t.sum/t.count}else t.temperature=null});const a=[];for(let e=0;e<this._config.days;e++){const n=new Date(t);n.setDate(n.getDate()+e),a.push(n)}const s=[];let l=[];for(let e=0;e<r;e++){const t=e*i,r={hour:t,label:h(t,this._config.time_format),cells:a.map(e=>{const i=`${u(e)}_${t}`,r=o[i],a={date:e,temperature:r?.temperature??null,hasData:r&&null!==r.temperature,isPartial:n&&i===n};return null!==a.temperature&&l.push(a.temperature),a})};s.push(r)}if(this._config.fill_gaps)for(let e=0;e<a.length;e++){let t=null;for(let n=0;n<s.length;n++){const i=s[n].cells[e];i.hasData?t=i.temperature:null!==t&&(i.temperature=t,i.hasData=!0,i.isFilled=!0)}}const c=s.filter(e=>this._shouldDisplayRow(e.hour));l=[],c.forEach(e=>{e.cells.forEach(e=>{null!==e.temperature&&l.push(e.temperature)})});const d={min:l.length>0?Math.min(...l):0,max:l.length>0?Math.max(...l):0,avg:l.length>0?l.reduce((e,t)=>e+t,0)/l.length:0};this._processedData={rows:c,dates:a,stats:d}}_shouldDisplayRow(e){const t=this._config.start_hour,n=this._config.end_hour;return t<=n?e>=t&&e<=n:e>=t||e<=n}_render(){if(this._config&&this._hass&&(this._content.innerHTML=`\n      <div class="card-header">\n        <span class="title">${d(this._config.title)}</span>\n        ${this._renderNavControls()}\n      </div>\n\n      ${this._error?this._renderError():""}\n      ${this._isLoading?this._renderLoading():""}\n      ${this._processedData&&!this._error?this._renderGrid():""}\n      ${this._processedData&&!this._error&&this._config.show_legend?this._renderLegend():""}\n      ${this._processedData&&!this._error?this._renderFooter():""}\n    `,this._processedData)){this._content.style.setProperty("--days-count",this._config.days);const e=this._getEffectiveSizing();this._content.style.setProperty("--cell-height",e.cellHeight),this._content.style.setProperty("--cell-width",e.cellWidth),this._content.style.setProperty("--cell-padding",e.cellPadding),this._content.style.setProperty("--cell-gap",e.cellGap),this._content.style.setProperty("--cell-font-size",e.cellFontSize),this._content.style.setProperty("--cell-border-radius",this._config.rounded_corners?"4px":"0")}}_renderNavControls(){const e=this._viewOffset<0,t=this._viewOffset<0;return`\n      <div class="nav-controls">\n        <button class="nav-btn" data-direction="back" aria-label="Previous period">&larr;</button>\n        <span class="date-range">${this._getDateRangeLabel()}</span>\n        <button class="nav-btn" data-direction="forward"\n                ${e?"":"disabled"}\n                aria-label="Next period">&rarr;</button>\n        <button class="nav-btn-current ${t?"":"hidden"}"\n                data-direction="current"\n                aria-label="Jump to current"\n                ${t?"":'aria-hidden="true"'}>Current</button>\n      </div>\n    `}_getDateRangeLabel(){if(!this._processedData)return"";const{dates:e}=this._processedData,t=e[0],n=e[e.length-1],i={month:"short",day:"numeric"};return`${t.toLocaleDateString(void 0,i)} - ${n.toLocaleDateString(void 0,i)}`}_renderLoading(){return'\n      <div class="loading">\n        <div class="loading-spinner"></div>\n        <div style="margin-top: 8px;">Loading temperature data...</div>\n      </div>\n    '}_renderError(){return`\n      <div class="error-message">\n        <div class="error-icon">!</div>\n        <div class="error-text">\n          <strong>${d(this._error.message)}</strong>\n          <div class="error-details">${d(this._error.details)}</div>\n        </div>\n      </div>\n    `}_renderGrid(){const{rows:e,dates:t}=this._processedData,n=t[0].toLocaleDateString(void 0,{month:"long",year:"numeric"}),i=t.map(e=>`<div class="date-header">${e.getDate()}</div>`).join("");return`\n      <div class="heatmap-grid">\n        <div class="month-header">${n}</div>\n        <div class="grid-wrapper">\n          <div class="time-labels">\n            ${e.map(e=>`<div class="time-label">${e.label}</div>`).join("")}\n          </div>\n          <div class="data-grid-container">\n            <div class="date-headers">\n              ${i}\n            </div>\n            <div class="data-grid">\n              ${e.map(e=>e.cells.map(e=>this._renderCell(e)).join("")).join("")}\n            </div>\n          </div>\n        </div>\n      </div>\n    `}_renderCell(e){if(!e.hasData)return'<div class="cell no-data"><span class="temperature">-</span></div>';const t=this._config.color_thresholds,i=this._config.interpolate_colors,r=this._config.color_interpolation,o=c(e.temperature,t,i,r),a=function(e){if(e.startsWith("var("))return"var(--primary-text-color)";const t=n(e);return t?(.299*t.r+.587*t.g+.114*t.b)/255>.5?"#000000":"#ffffff":"var(--primary-text-color)"}(o),s=this._config.decimals,l=e.isPartial?"*":"",d=e.isPartial?" (in progress)":"",h=e.isFilled?" (estimated)":"";let p="cell";return e.isPartial&&(p+=" partial"),e.isFilled&&(p+=" filled"),`\n      <div class="${p}"\n           style="background-color: ${o}; color: ${a}"\n           data-temperature="${e.temperature}"\n           data-date="${e.date.toISOString()}"\n           data-partial="${e.isPartial?"true":"false"}"\n           data-filled="${e.isFilled?"true":"false"}"\n           tabindex="0"\n           role="button"\n           aria-label="Temperature ${e.temperature.toFixed(s)}${d}${h}">\n        <span class="temperature">${e.temperature.toFixed(s)}${l}</span>\n      </div>\n    `}_renderLegend(){const e=this._config.color_thresholds;if(!e||0===e.length)return"";const t=this._getUnit(),n=this._config.interpolate_colors,i=this._config.color_interpolation,r=e[0].value,o=e[e.length-1].value-r||1;let a;if(n&&e.length>=2){const t=[];for(let n=0;n<=20;n++){const a=n/20,s=c(r+a*o,e,!0,i);t.push(`${s} ${(100*a).toFixed(1)}%`)}a=t.join(", ")}else{const t=[];for(let n=0;n<e.length;n++){const i=e[n],a=(i.value-r)/o*100;if(t.push(`${i.color} ${a.toFixed(1)}%`),n<e.length-1){const a=(e[n+1].value-r)/o*100;t.push(`${i.color} ${a.toFixed(1)}%`)}}a=t.join(", ")}let s=-1/0;return`\n    <div class="legend">\n      <div class="legend-bar" style="background: linear-gradient(to right, ${a})"></div>\n      <div class="legend-labels" style="position:relative;">\n        ${e.map(e=>{const n=(e.value-r)/o*100;return n-s<8?"":(s=n,`<span style="position:absolute; left:${n.toFixed(1)}%;">${e.value}${t}</span>`)}).join("")}\n      </div>\n    </div>\n  `}_renderFooter(){const{stats:e}=this._processedData,t=this._getUnit(),n=this._config.decimals;let i="";if(this._config.show_entity_name){const e=this._hass?.states[this._config.entity];i=`<div class="entity-name">${d(e?.attributes?.friendly_name||this._config.entity)}</div>`}return`\n      <div class="footer">\n        <div class="footer-stats">\n          <span>Min: ${e.min.toFixed(n)} ${t}</span>\n          <span>Max: ${e.max.toFixed(n)} ${t}</span>\n          <span>Avg: ${e.avg.toFixed(n)} ${t}</span>\n        </div>\n        ${i}\n      </div>\n    `}_getUnit(){let e;if(this._config.unit)e=this._config.unit;else{const t=this._hass?.states[this._config.entity];e=t?.attributes?.unit_of_measurement||"°F"}return this._config.show_degree_symbol||(e=e.replace("°","")),e}_handleClick(e){const t=e.target.closest(".nav-btn, .nav-btn-current");if(t&&!t.disabled){const e=t.dataset.direction;return void this._handleNavigation(e)}const n=e.target.closest(".cell");n&&!n.classList.contains("no-data")&&this._handleCellClick(n)}_handleNavigation(e){"back"===e?this._viewOffset-=this._config.days:"forward"===e?(this._viewOffset+=this._config.days,this._viewOffset>0&&(this._viewOffset=0)):"current"===e&&(this._viewOffset=0),this._fetchHistoryData()}_handleCellClick(e){switch(this._config.click_action){case"more-info":this._showMoreInfo();break;case"tooltip":this._showTooltip(e)}}_showMoreInfo(){this.dispatchEvent(new CustomEvent("hass-more-info",{bubbles:!0,composed:!0,detail:{entityId:this._config.entity}}))}_showTooltip(e){const t=parseFloat(e.dataset.temperature),n=new Date(e.dataset.date),i="true"===e.dataset.partial,r="true"===e.dataset.filled,o=this.shadowRoot.querySelector(".tooltip");o&&o.remove();const a=document.createElement("div");a.className="tooltip";const s=n.toLocaleString(void 0,{month:"short",day:"numeric"}),l=this._getUnit(),c=this._config.decimals,d=i?"<div><em>(in progress)</em></div>":"",h=r?"<div><em>(estimated - gap filled)</em></div>":"";a.innerHTML=`\n      <div><strong>${s}</strong></div>\n      <div>Temperature: ${t.toFixed(c)} ${l}</div>\n      <div>Mode: ${this._config.aggregation_mode}</div>\n      ${d}\n      ${h}\n    `;const p=e.getBoundingClientRect(),u=this._content.getBoundingClientRect();a.style.left=p.left-u.left+p.width/2+"px",a.style.top=p.bottom-u.top+4+"px",a.style.transform="translateX(-50%)",this._content.appendChild(a),setTimeout(()=>{a.parentElement&&a.remove()},3e3)}_getEffectiveSizing(){return this._config.compact?{cellHeight:"24px",cellWidth:"1fr",cellPadding:"1px",cellGap:"1px",cellFontSize:"9px"}:{cellHeight:p(this._config.cell_height,"36px"),cellWidth:p(this._config.cell_width,"1fr"),cellPadding:p(this._config.cell_padding,"2px"),cellGap:p(this._config.cell_gap,"2px"),cellFontSize:p(this._config.cell_font_size,"11px")}}}class m extends HTMLElement{set hass(e){this._hass=e,this.content||this._buildEditor()}async setConfig(e){this._config={...e||{}};const t=await window.loadCardHelpers();if(!customElements.get("ha-entity-picker")){const e=await t.createCardElement({type:"entities",entities:[]});await e.constructor.getConfigElement()}this._config={entity:"",title:"Temperature History",days:7,time_interval:2,time_format:"24",start_hour:0,end_hour:23,aggregation_mode:"average",decimals:1,unit:"",refresh_interval:300,click_action:"more-info",show_entity_name:!1,show_legend:!1,cell_height:36,cell_width:"1fr",cell_padding:2,cell_gap:2,cell_font_size:11,compact:!1,rounded_corners:!0,interpolate_colors:!1,color_interpolation:"hsl",color_thresholds:[],data_source:"auto",statistic_type:"mean",fill_gaps:!1,...this._config},this.content&&this._updateValues()}getConfig(){return{...this._config}}_buildEditor(){this.content=document.createElement("div"),this.content.style.display="grid",this.content.style.gridGap="8px",this.content.style.padding="8px",this.appendChild(this.content),this.container_threshold={},this.fields={};[{type:"entity",key:"entity",label:"Entity",required:!0},{type:"text",key:"title",label:"Title"},{type:"number",key:"days",label:"Days",min:1,max:365},{type:"number",key:"time_interval",label:"Time Interval (hours)",min:1,max:24},{type:"select",key:"time_format",label:"Time Format",options:{24:"24h",12:"12h"}},{type:"number",key:"start_hour",label:"Start Hour",min:0,max:23},{type:"number",key:"end_hour",label:"End Hour",min:0,max:23},{type:"select",key:"aggregation_mode",label:"Aggregation Mode",options:{average:"Average",min:"Min",max:"Max"}},{type:"select",key:"data_source",label:"Data Source",options:{auto:"Auto (statistics for past, history for current)",history:"History only (limited by purge_keep_days)",statistics:"Statistics only (long-term hourly data)"}},{type:"select",key:"statistic_type",label:"Statistic Type",options:{mean:"Average",max:"Maximum",min:"Minimum"}},{type:"number",key:"decimals",label:"Decimals",min:0,max:2},{type:"select",key:"unit",label:"Unit",options:{"°C":"Celsius","°F":"Fahrenheit"}},{type:"number",key:"refresh_interval",label:"Refresh Interval (s)",min:10,max:3600},{type:"select",key:"click_action",label:"Click Action",options:{none:"None","more-info":"More Info",tooltip:"Tooltip"}},{type:"switch",key:"show_entity_name",label:"Show Entity Name"},{type:"switch",key:"show_legend",label:"Show Legend"},{type:"switch",key:"show_degree_symbol",label:"Show Degree Symbol (°)"},{type:"number",key:"cell_height",label:"Cell Height",min:10,max:200},{type:"text",key:"cell_width",label:"Cell Width (px or fr)"},{type:"number",key:"cell_padding",label:"Cell Padding",min:0,max:50},{type:"number",key:"cell_gap",label:"Cell Gap",min:0,max:50},{type:"number",key:"cell_font_size",label:"Cell Font Size",min:6,max:32},{type:"switch",key:"compact",label:"Compact Mode"},{type:"switch",key:"rounded_corners",label:"Rounded Corners"},{type:"switch",key:"interpolate_colors",label:"Interpolate Colors"},{type:"select",key:"color_interpolation",label:"Color Interpolation",options:{rgb:"RGB",gamma:"Gamma RGB",hsl:"HSL",lab:"LAB"}},{type:"switch",key:"fill_gaps",label:"Fill Gaps - use at your own risk (forward-fills last known value into empty buckets)"},{type:"thresholds",key:"color_thresholds",label:"Colors"}].forEach(e=>this._createField(e)),this._updateValues()}_createThresholdEditor(){const e=(e,t)=>{const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center",n.style.gap="8px";const i=document.createElement("ha-textfield");i.type="number",i.value=e.value,i.addEventListener("change",e=>{e.stopPropagation();const n=[...this._config.color_thresholds],i={...this._config.color_thresholds[t]};i.value=Number(e.target.value),n[t]=i,this._onFieldChange("color_thresholds",n),this._refreshThresholdEditor()});const r=document.createElement("input");r.type="color",r.value=e.color,r.addEventListener("change",e=>{e.stopPropagation();const n=[...this._config.color_thresholds],i={...this._config.color_thresholds[t]};i.color=e.target.value,n[t]=i,this._onFieldChange("color_thresholds",n),this._refreshThresholdEditor()});const o=document.createElement("button");o.textContent="X",o.style.cursor="pointer",o.addEventListener("click",e=>{e.stopPropagation();const n=[...this._config.color_thresholds];n.splice(t,1),this._onFieldChange("color_thresholds",n),this._refreshThresholdEditor()}),n.appendChild(i),n.appendChild(r),n.appendChild(o),this.container_threshold.appendChild(n)};this._config.color_thresholds||(this._config.color_thresholds=[]),this._config.color_thresholds.forEach((t,n)=>e(t,n))}_refreshThresholdEditor(){for(;this.container_threshold.firstChild;)this.container_threshold.removeChild(this.container_threshold.firstChild);this._createThresholdEditor()}_updateValues(){if(this._config)for(const e in this.fields){const t=this.fields[e].input;"checkbox"===this.fields[e].type||"switch"===this.fields[e].type?t.checked=!!this._config[e]:"thresholds"===this.fields[e].type?this._refreshThresholdEditor():t.value=void 0!==this._config[e]?this._config[e]:""}}_createField({type:e,key:t,label:n,min:i,max:r,options:o,required:a}){const s=document.createElement("div");let l;if(s.style.display="flex",s.style.flexDirection="column",s.style.marginBottom="8px","switch"===e){s.style.flexDirection="row",s.style.alignItems="center",s.style.gap="8px",l=document.createElement("ha-switch");const e=document.createElement("label");e.textContent=n,s.appendChild(l),s.appendChild(e),l.addEventListener("change",e=>{e.stopPropagation(),this._onFieldChange(t,l.checked)})}else if("thresholds"===e){const e=document.createElement("label");e.textContent=n,s.appendChild(e);const i=document.createElement("div");i.style.display="grid",i.style.gridGap="8px",s.appendChild(i),this.container_threshold=i;const r=document.createElement("button");r.textContent="Add Threshold",r.style.marginTop="8px",r.addEventListener("click",e=>{e.stopPropagation();const n=[...this._config.color_thresholds];n.push({value:0,color:"#ffffff"}),this._onFieldChange(t,n)}),s.appendChild(r)}else{const c=document.createElement("label");if(c.textContent=n,s.appendChild(c),"entity"===e)l=document.createElement("ha-entity-picker"),l.setAttribute("allow-custom-entity",""),l.hass=this._hass,l.addEventListener("value-changed",e=>{e.stopPropagation(),this._onFieldChange(t,e.detail.value)});else if("number"===e||"text"===e)l=document.createElement("ha-textfield"),l.type=e,void 0!==i&&(l.min=i),void 0!==r&&(l.max=r),a&&(l.required=!0),l.addEventListener("change",n=>{n.stopPropagation();const i="number"===e?Number(l.value):l.value;this._onFieldChange(t,i)});else if("select"===e){l=document.createElement("ha-select");for(const e in o){const t=document.createElement("mwc-list-item");t.value=e,t.innerText=o[e],l.appendChild(t)}l.addEventListener("selected",e=>{e.stopPropagation(),this._onFieldChange(t,e.target.value)}),l.addEventListener("closed",e=>{e.stopPropagation()})}s.appendChild(l)}this.fields[t]={},this.fields[t].input=l,this.fields[t].type=e,this.content.appendChild(s)}_onFieldChange(e,t){const n={...this._config,[e]:t};this._config=n,this.dispatchEvent(new CustomEvent("config-changed",{detail:{config:n},bubbles:!0,composed:!0}))}disconnectedCallback(){this.fields={},this.container_threshold=null}}window.customCards=window.customCards||[],window.customCards.push({type:"ha-temperature-heatmap-card",name:"Temperature Heatmap Card",description:"Display temperature history as a color-coded heatmap"}),console.info("%c TEMPERATURE-HEATMAP-CARD %c v0.6.0 ","color: lightblue; font-weight: bold; background: black","color: white; font-weight: bold; background: dimgray"),customElements.define("ha-temperature-heatmap-card-editor",m),customElements.define("ha-temperature-heatmap-card",_);
//# sourceMappingURL=ha-temperature-heatmap-card.js.map
